name: CI

on:
  pull_request:
    branches:
      - main

jobs:
  branch-naming:
    name: Validate branch name
    runs-on: ubuntu-latest
    steps:
      - name: Check branch name format
        run: |
          BRANCH="${{ github.head_ref }}"
          echo "Checking branch name: $BRANCH"

          # Must start with a valid prefix
          if [[ ! "$BRANCH" =~ ^(feature|bugfix|hotfix|chore|docs|refactor|test)/ ]]; then
            echo "::error::Branch name must start with a valid prefix (feature/, bugfix/, hotfix/, chore/, docs/, refactor/, test/)"
            exit 1
          fi

          # After prefix, must be lowercase kebab-case
          SUFFIX="${BRANCH#*/}"
          if [[ ! "$SUFFIX" =~ ^[a-z0-9]+(-[a-z0-9]+)*$ ]]; then
            echo "::error::Branch name after prefix must be lowercase kebab-case (e.g., feature/my-new-feature)"
            exit 1
          fi

          echo "Branch name is valid."

  format:
    name: Check formatting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rokit
        uses: CompeyDev/setup-rokit@v0.1.2

      - name: Check formatting
        run: lune run ./Scripts/CheckFormatting.luau

  test:
    name: Run tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rokit
        uses: CompeyDev/setup-rokit@v0.1.2

      - name: Install dependencies
        run: wally install

      - name: Run tests
        run: lune run ./Scripts/RunTests.luau

  analyze:
    name: Static analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rokit
        uses: CompeyDev/setup-rokit@v0.1.2

      - name: Install dependencies
        run: wally install

      - name: Setup Lune typedefs
        run: lune setup --no-update-luaurc

      - name: Run static analysis
        run: lune run ./Scripts/RunStaticAnalysis.luau

  changelog:
    name: Check changelog format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rokit
        uses: CompeyDev/setup-rokit@v0.1.2

      - name: Check changelog format
        run: lune run ./Scripts/CheckChangelogFormat.luau

  rokit-format:
    name: Check rokit.toml format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rokit
        uses: CompeyDev/setup-rokit@v0.1.2

      - name: Check rokit.toml format
        run: lune run ./Scripts/CheckRokitFormat.luau

  wally-format:
    name: Check wally.toml format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rokit
        uses: CompeyDev/setup-rokit@v0.1.2

      - name: Check wally.toml format
        run: lune run ./Scripts/CheckWallyFormat.luau

  file-headers:
    name: Check file headers
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rokit
        uses: CompeyDev/setup-rokit@v0.1.2

      - name: Check file headers
        run: lune run ./Scripts/CheckFileHeaders.luau

  luaurc-format:
    name: Check .luaurc format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rokit
        uses: CompeyDev/setup-rokit@v0.1.2

      - name: Check .luaurc format
        run: lune run ./Scripts/CheckLuaurcFormat.luau

  json-format:
    name: Check JSON format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Prettier
        run: npm install -g prettier

      - name: Setup Rokit
        uses: CompeyDev/setup-rokit@v0.1.2

      - name: Check JSON format
        run: lune run ./Scripts/CheckJsonFormat.luau

  no-tabs:
    name: Check for tabs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rokit
        uses: CompeyDev/setup-rokit@v0.1.2

      - name: Check for tabs
        run: lune run ./Scripts/CheckNoTabs.luau
