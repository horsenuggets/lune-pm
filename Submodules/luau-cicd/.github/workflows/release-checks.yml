name: Release checks

on:
  pull_request:
    branches:
      - release

jobs:
  pr-title:
    name: Validate PR title
    runs-on: ubuntu-latest
    steps:
      - name: Check PR title format
        run: |
          TITLE="${{ github.event.pull_request.title }}"
          echo "Checking PR title: $TITLE"

          # Must be exactly "Release X.Y.Z"
          if [[ ! "$TITLE" =~ ^Release\ [0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::PR title must be exactly 'Release X.Y.Z' (e.g., 'Release 1.2.3')"
            exit 1
          fi

          echo "PR title is valid."

  diff-check:
    name: Verify diff matches main
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check diff with main
        run: |
          git fetch origin main

          # Get the diff between the PR branch and main
          DIFF=$(git diff origin/main..HEAD)

          if [ -n "$DIFF" ]; then
            echo "::error::PR branch has changes that differ from main. The release branch must contain exactly what is in main."
            echo "Diff:"
            echo "$DIFF"
            exit 1
          fi

          echo "PR branch matches main exactly."

  format:
    name: Check formatting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rokit
        uses: CompeyDev/setup-rokit@v0.1.2

      - name: Check formatting
        run: lune run ./Scripts/CheckFormatting.luau

  test:
    name: Run tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rokit
        uses: CompeyDev/setup-rokit@v0.1.2

      - name: Install dependencies
        run: wally install

      - name: Run tests
        run: lune run ./Scripts/RunTests.luau

  analyze:
    name: Static analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rokit
        uses: CompeyDev/setup-rokit@v0.1.2

      - name: Install dependencies
        run: wally install

      - name: Setup Lune typedefs
        run: lune setup --no-update-luaurc

      - name: Run static analysis
        run: lune run ./Scripts/RunStaticAnalysis.luau

  json-format:
    name: Check JSON format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Prettier
        run: npm install -g prettier

      - name: Setup Rokit
        uses: CompeyDev/setup-rokit@v0.1.2

      - name: Check JSON format
        run: lune run ./Scripts/CheckJsonFormat.luau

  wally-auth:
    name: Verify Wally auth
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check WALLY_AUTH secret
        env:
          WALLY_AUTH: ${{ secrets.WALLY_AUTH }}
        run: |
          # Only check if this is a Wally package (has wally.toml)
          if [ ! -f "wally.toml" ]; then
            echo "No wally.toml found, skipping WALLY_AUTH check."
            exit 0
          fi

          if [ -z "$WALLY_AUTH" ]; then
            echo "::error::WALLY_AUTH secret is not configured. This is required for publishing to Wally."
            echo "::error::Add the secret using: gh secret set WALLY_AUTH < ~/.wally/auth.toml"
            exit 1
          fi

          echo "WALLY_AUTH secret is configured."

  version:
    name: Validate version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Rokit
        uses: CompeyDev/setup-rokit@v0.1.2

      - name: Check version update
        run: lune run ./Scripts/EnsureProperVersionUpdate.luau

      - name: Check version match
        run: lune run ./Scripts/CheckVersionMatch.luau

      - name: Check changelog entry
        run: lune run ./Scripts/CheckChangelogVersion.luau

      - name: Check changelog format
        run: lune run ./Scripts/CheckChangelogFormat.luau

      - name: Verify PR title matches VERSION
        run: |
          VERSION=$(cat VERSION | tr -d '[:space:]')
          EXPECTED_TITLE="Release $VERSION"
          ACTUAL_TITLE="${{ github.event.pull_request.title }}"

          if [ "$EXPECTED_TITLE" != "$ACTUAL_TITLE" ]; then
            echo "::error::PR title '$ACTUAL_TITLE' does not match VERSION file. Expected '$EXPECTED_TITLE'"
            exit 1
          fi

          echo "PR title matches VERSION file."
